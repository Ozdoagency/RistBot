import { getDb } from './mongodb.js';
import { generateResponseWithRetry } from './utils.js';
import logger from './logger.js'; // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ —Ñ–æ–ª–ª–æ—É-–∞–ø–∞ —á–µ—Ä–µ–∑ HugFace
export const generateFollowUpMessage = async (chatId, stage) => {
  const prompt = `
  –¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –∏ –≤–µ–¥–µ–Ω–∏—é –¥–∏–∞–ª–æ–≥–∞ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏. –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ—Å—Ç–∞–ª –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è. 
  –¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –ª—É—á—à–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏ –ø—Ä–æ–¥–∞–∂ –∏ –≤–æ–≤–ª–µ—á–µ–Ω–∏—è, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –≤ –¥–∏–∞–ª–æ–≥. 
  –í–æ—Ç —ç—Ç–∞–ø—ã —Ç–≤–æ–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π:

  1. **–≠–º–ø–∞—Ç–∏—è –∏ –¥—Ä—É–∂–µ–ª—é–±–∏–µ.** –£–±–µ–¥–∏—Å—å, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç —á—É–≤—Å—Ç–≤—É–µ—Ç –∫–æ–º—Ñ–æ—Ä—Ç.
  2. **–î–æ–±–∞–≤—å —Ü–µ–Ω–Ω–æ—Å—Ç—å.** –ù–∞–ø–æ–º–Ω–∏, –∫–∞–∫—É—é –ø—Ä–æ–±–ª–µ–º—É —Ä–µ—à–∏—Ç —Ç–≤–æ–π –ø—Ä–æ–¥—É–∫—Ç –∏–ª–∏ —É—Å–ª—É–≥–∞.
  3. **–£–º–µ–Ω—å—à–∏ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ.** –ü—Ä–µ–¥–ª–æ–∂–∏ –ª—ë–≥–∫–∏–π —Å–ø–æ—Å–æ–± –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä.

  –°–∏—Ç—É–∞—Ü–∏—è:
  - –£—Å–ª—É–≥–∞: –û–Ω–ª–∞–π–Ω-—É—Ä–æ–∫–∏ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏.
  - –¶–µ–ª—å: –ó–∞–ø–∏—Å–∞—Ç—å —Ä–µ–±—ë–Ω–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø—Ä–æ–±–Ω—ã–µ —É—Ä–æ–∫–∏.

  –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–ø–∏—Å–∞—Ç—å **${stage} —Ñ–æ–ª–ª–æ—É-–∞–ø**, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–≤–ª–µ—á–µ—Ç –≤–Ω–∏–º–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –≤–æ–≤–ª–µ—á—ë—Ç –µ–≥–æ –≤ –¥–∏–∞–ª–æ–≥.
  –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–º, –ø–æ–Ω—è—Ç–Ω—ã–º, –Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º.`;

  try {
    const response = await generateResponseWithRetry(prompt, 'followUp');
    logger.info(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Ç–µ–∫—Å—Ç —Ñ–æ–ª–ª–æ—É-–∞–ø–∞ –¥–ª—è ${stage} —Å—Ç–∞–¥–∏–∏: ${response}`);
    return response;
  } catch (error) {
    logger.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–æ–ª–ª–æ—É-–∞–ø–∞: ${error.message}`);
    return "–ú—ã –∑–∞–º–µ—Ç–∏–ª–∏, —á—Ç–æ –≤—ã –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∏. –ù–∞–ø–∏—à–∏—Ç–µ, –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã! üòä"; // –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ç–µ–∫—Å—Ç
  }
};

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ–ª–ª–æ—É-–∞–ø–æ–≤
export const sendFollowUps = async (bot, chatId) => {
  const db = getDb(); // –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
  const collection = db.collection('followUps'); // –ö–æ–ª–ª–µ–∫—Ü–∏—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ñ–æ–ª–ª–æ—É-–∞–ø–æ–≤
  const timers = {};

  // –ü—Ä–æ–≤–µ—Ä–∫–∞, –±—ã–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
  const isQualified = await collection.findOne({ userId: chatId, qualified: true });
  if (isQualified) {
    logger.info(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${chatId} —É–∂–µ –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, —Ñ–æ–ª–ª–æ—É-–∞–ø—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è.`);
    return null; // –§–æ–ª–ª–æ—É-–∞–ø—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è
  }

  // –ü–µ—Ä–≤—ã–π —Ñ–æ–ª–ª–æ—É-–∞–ø —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç
  timers.first = setTimeout(async () => {
    const followUpMessage = await generateFollowUpMessage(chatId, "–ø–µ—Ä–≤–æ–≥–æ");
    bot.sendMessage(chatId, followUpMessage);
    logger.info(`–ü–µ—Ä–≤—ã–π —Ñ–æ–ª–ª–æ—É-–∞–ø –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${chatId}`);
    await collection.updateOne(
      { userId: chatId },
      { $set: { firstFollowUpSent: true } },
      { upsert: true }
    );
  }, 15 * 60 * 1000); // 15 –º–∏–Ω—É—Ç

  // –í—Ç–æ—Ä–æ–π —Ñ–æ–ª–ª–æ—É-–∞–ø —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞
  timers.second = setTimeout(async () => {
    const followUpMessage = await generateFollowUpMessage(chatId, "–≤—Ç–æ—Ä–æ–≥–æ");
    bot.sendMessage(chatId, followUpMessage);
    logger.info(`–í—Ç–æ—Ä–æ–π —Ñ–æ–ª–ª–æ—É-–∞–ø –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${chatId}`);
    await collection.updateOne(
      { userId: chatId },
      { $set: { secondFollowUpSent: true } },
      { upsert: true }
    );
  }, 2 * 60 * 60 * 1000); // 2 —á–∞—Å–∞

  // –¢—Ä–µ—Ç–∏–π —Ñ–æ–ª–ª–æ—É-–∞–ø —á–µ—Ä–µ–∑ 5 —á–∞—Å–æ–≤
  timers.third = setTimeout(async () => {
    const followUpMessage = await generateFollowUpMessage(chatId, "—Ç—Ä–µ—Ç—å–µ–≥–æ");
    bot.sendMessage(chatId, followUpMessage);
    logger.info(`–¢—Ä–µ—Ç–∏–π —Ñ–æ–ª–ª–æ—É-–∞–ø –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${chatId}`);
    await collection.updateOne(
      { userId: chatId },
      { $set: { thirdFollowUpSent: true } },
      { upsert: true }
    );
  }, 5 * 60 * 60 * 1000); // 5 —á–∞—Å–æ–≤

  return timers;
};
