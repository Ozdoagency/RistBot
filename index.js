import TelegramBot from 'node-telegram-bot-api';
import express from 'express';

const TELEGRAM_TOKEN = '7733244277:AAFa1YylutZKqaEw0LjBTDRKxZymWz91LPs';
const WEBHOOK_URL = 'https://ristbot.onrender.com';

const bot = new TelegramBot(TELEGRAM_TOKEN);
bot.setWebHook(`${WEBHOOK_URL}/bot${TELEGRAM_TOKEN}`);

const app = express();
app.use(express.json());

const userState = {}; // Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Webhook
app.post(`/bot${TELEGRAM_TOKEN}`, (req, res) => {
  bot.processUpdate(req.body);
  res.sendStatus(200); // Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ HTTP 200, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Telegram Ð½Ðµ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÐ» Ð·Ð°Ð¿Ñ€Ð¾Ñ
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.onText(/\/start/, async (msg) => {
  const chatId = msg.chat?.id;

  if (!chatId) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ°: Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ chatId.");
    return;
  }

  // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  if (userState[chatId]?.started) {
    console.log(`ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start ÑƒÐ¶Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð° Ð´Ð»Ñ chatId: ${chatId}`);
    return;
  }

  userState[chatId] = { started: true };

  try {
    console.log(`ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start Ð´Ð»Ñ chatId: ${chatId}`);
    await bot.sendMessage(chatId, "ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð‘Ð¾Ñ‚ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ.");
  } catch (error) {
    console.error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start Ð´Ð»Ñ chatId ${chatId}: ${error.message}`);
  }
});

// Ð¢ÐµÑÑ‚Ð¾Ð²Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on("message", async (msg) => {
  const chatId = msg.chat?.id;

  if (!chatId || msg.text?.startsWith("/")) return;

  try {
    console.log(`ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ chatId: ${chatId}`);
    await bot.sendMessage(chatId, `Ð’Ñ‹ ÑÐºÐ°Ð·Ð°Ð»Ð¸: "${msg.text}"`);
  } catch (error) {
    console.error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð´Ð»Ñ chatId ${chatId}: ${error.message}`);
  }
});

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð°
app.get('/', (req, res) => {
  res.send('Ð¡ÐµÑ€Ð²ÐµÑ€ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚! ðŸš€');
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Ð¡ÐµÑ€Ð²ÐµÑ€ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
});
